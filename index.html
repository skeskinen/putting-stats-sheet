<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Putting Stats</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; margin: 24px; }
    .row { margin-top: 8px; }
    input, button { font-size: 16px; padding: 8px; }
    pre { background: #f6f6f6; padding: 12px; border-radius: 8px; overflow: auto; }
    .muted { color: #666; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h1>Disc Golf Putting Stats</h1>
  <p class="muted">Hardcoded setup: OAuth client ID and sheet name are embedded. Configure a spreadsheet below once per browser.</p>

  <div id="setup">
    <div class="row"><strong>First-time setup</strong></div>
    <div class="row">
      <button id="btnCreateSheet">Create New Spreadsheet</button>
      <span class="muted">Creates a sheet with tab <code>putting-stats</code>.</span>
    </div>
    <div class="row">
      <input id="inputSheetId" placeholder="Paste existing Spreadsheet ID" size="40" />
      <button id="btnUseSheetId">Use ID</button>
    </div>
    <div id="msg" class="row muted"></div>
  </div>

  

  <div id="controls" class="row" style="display:none">
    <button id="btnSignIn">Sign in with Google</button>
    <button id="btnRead">Read A1:C10</button>
    <button id="btnAppend">Append row</button>
    <span id="status" style="margin-left: 8px; font-weight: 600">Signed out</span>
  </div>

  <pre id="out"></pre>

  <div id="sessionUI" style="display:none">
    <div class="row"><button id="btnNewSession">New Session</button> <span id="sessInfo" class="muted"></span></div>
    <div class="row"><strong>Current:</strong> <span id="currentPutt"></span></div>
    <div class="row"><span class="muted">Next: <span id="nextPutts"></span></span> • <span id="progress">0/8</span></div>
    <div class="row">
      <button id="btnSuccess">Success (1)</button>
      <button id="btnFail">Fail (0)</button>
    </div>
  </div>

  <script>
    let tokenClient, accessToken, scopes = "https://www.googleapis.com/auth/spreadsheets";
    const CLIENT_ID = "775302818197-p5jn3hq79uv93b66n5109b264sdgdctc.apps.googleusercontent.com"; // provided by user
    const SHEET_NAME = "putting-stats"; // hardcoded sheet/tab name
    const SPREADSHEET_ID = ""; // optional: hardcode an existing spreadsheetId to skip setup
    const STORAGE_KEY = "putting_stats_spreadsheet_id";
    let spreadsheetId = null;
    const PUTTS = [
      "L 6m","L 8m","L 10m","L step",
      "R 6m","R 8m","R 10m","R step"
    ];
    const HEADERS = ["session","date","time", ...PUTTS];

    // Session state
    let session = null; // { number, date, time, order[], index, results: Map name->0/1 }

    function setMsg(text) {
      const el = document.getElementById("msg");
      if (el) el.textContent = text || "";
    }

    function updateUI() {
      const hasId = !!spreadsheetId;
      document.getElementById("setup").style.display = hasId ? "none" : "block";
      document.getElementById("controls").style.display = hasId ? "block" : "none";
      document.getElementById("sessionUI").style.display = hasId ? "block" : "none";
    }

    async function ensureHeader(id) {
      // Check first row; if missing or different, write headers
      const range = `${SHEET_NAME}!A1:K1`;
      const res = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(range)}`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      if (!res.ok) throw new Error(`Failed to read headers: ${await res.text()}`);
      const data = await res.json();
      const row = (data.values && data.values[0]) || [];
      const equal = row.length === HEADERS.length && row.every((v,i)=>String(v)===String(HEADERS[i]));
      if (!equal) {
        const put = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(range)}?valueInputOption=RAW`,
          {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${accessToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ values: [HEADERS] }),
          }
        );
        if (!put.ok) throw new Error(`Failed to set headers: ${await put.text()}`);
      }
    }

    async function getNextSessionNumber(id) {
      const range = `${SHEET_NAME}!A2:A`;
      const res = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(range)}?majorDimension=COLUMNS`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      if (!res.ok) return 1;
      const data = await res.json();
      const col = (data.values && data.values[0]) || [];
      let max = 0;
      for (const v of col) {
        const n = Number(v);
        if (Number.isFinite(n)) max = Math.max(max, n);
      }
      return max + 1;
    }

    function shuffle(arr) {
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--) {
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function nowParts() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return { date: `${yyyy}-${mm}-${dd}`, time: `${hh}:${mi}` };
    }

    async function startSession() {
      try {
        setMsg("");
        await ensureSignedIn();
        const id = await ensureSpreadsheet();
        await ensureHeader(id);
        const number = await getNextSessionNumber(id);
        const { date, time } = nowParts();
        session = {
          number,
          date,
          time,
          order: shuffle(PUTTS),
          index: 0,
          results: {}
        };
        updateSessionUI();
        document.getElementById("sessionUI").style.display = "block";
      } catch (e) {
        setMsg(String(e));
      }
    }

    function updateSessionUI() {
      if (!session) return;
      document.getElementById("sessInfo").textContent = `Session ${session.number} — ${session.date} ${session.time}`;
      const curr = session.order[session.index];
      document.getElementById("currentPutt").textContent = curr ? curr : "Done";
      const next1 = session.order[session.index+1] || "";
      const next2 = session.order[session.index+2] || "";
      document.getElementById("nextPutts").textContent = [next1,next2].filter(Boolean).join(", ");
      document.getElementById("progress").textContent = `${Math.min(session.index, PUTTS.length)}/${PUTTS.length}`;
      const enable = session.index < PUTTS.length;
      document.getElementById("btnSuccess").disabled = !enable;
      document.getElementById("btnFail").disabled = !enable;
    }

    async function recordResult(val) {
      if (!session) return;
      const curr = session.order[session.index];
      if (curr) session.results[curr] = val;
      session.index++;
      if (session.index >= PUTTS.length) {
        await finalizeSession();
      }
      updateSessionUI();
    }

    async function finalizeSession() {
      try {
        const row = [session.number, session.date, session.time, ...PUTTS.map(p => session.results[p] ? 1 : 0)];
        const id = spreadsheetId;
        const res = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(SHEET_NAME)}!A:K:append?valueInputOption=USER_ENTERED`,
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${accessToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ values: [row] }),
          }
        );
        if (!res.ok) throw new Error(`Failed to append session: ${await res.text()}`);
        setMsg("Session saved.");
      } catch (e) {
        setMsg(String(e));
      }
    }

    function initAuth() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: scopes,
        callback: (resp) => {
          accessToken = resp.access_token;
          document.getElementById("status").textContent = "Signed in";
        },
      });
    }

    function signIn() {
      if (!tokenClient) initAuth();
      tokenClient.clientId = CLIENT_ID;
      tokenClient.requestAccessToken();
    }

    // Ensure we have an access token; if not, trigger sign-in popup from this user gesture
    function ensureSignedIn() {
      return new Promise((resolve) => {
        if (accessToken) return resolve();
        if (!tokenClient) initAuth();
        tokenClient.clientId = CLIENT_ID;
        const prevCb = tokenClient.callback;
        tokenClient.callback = (resp) => {
          accessToken = resp.access_token;
          document.getElementById("status").textContent = "Signed in";
          tokenClient.callback = prevCb; // restore
          resolve();
        };
        tokenClient.requestAccessToken();
      });
    }

    async function ensureSpreadsheet() {
      if (!spreadsheetId) {
        spreadsheetId = SPREADSHEET_ID || localStorage.getItem(STORAGE_KEY) || null;
      }
      if (!spreadsheetId) throw new Error("Spreadsheet not configured. Create one or paste an ID.");
      const meta = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=sheets.properties.title`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      if (!meta.ok) {
        const err = await meta.text();
        throw new Error(`Failed to fetch spreadsheet metadata: ${err}`);
      }
      const metaJson = await meta.json();
      const titles = (metaJson.sheets || []).map(s => s.properties && s.properties.title);
      if (!titles.includes(SHEET_NAME)) {
        await addSheet(spreadsheetId, SHEET_NAME);
      }
      return spreadsheetId;
    }

    async function createSpreadsheet() {
      const body = {
        properties: { title: "Disc Golf Putting Stats" },
        sheets: [{ properties: { title: SHEET_NAME } }],
      };
      const res = await fetch("https://sheets.googleapis.com/v4/spreadsheets", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(body),
      });
      if (!res.ok) {
        const err = await res.text();
        throw new Error(`Failed to create spreadsheet: ${err}`);
      }
      return await res.json();
    }

    async function addSheet(spreadsheetId, title) {
      const body = {
        requests: [ { addSheet: { properties: { title } } } ]
      };
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(body),
      });
      if (!res.ok) {
        const err = await res.text();
        throw new Error(`Failed to add sheet: ${err}`);
      }
      return await res.json();
    }

    async function readSheet() {
      if (!accessToken) await ensureSignedIn();
      const id = await ensureSpreadsheet();
      const range = `${SHEET_NAME}!A1:C10`;
      const res = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(range)}?majorDimension=ROWS`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      const data = await res.json();
      document.getElementById("out").textContent = JSON.stringify(data.values || [], null, 2);
    }

    async function appendRow() {
      if (!accessToken) await ensureSignedIn();
      const id = await ensureSpreadsheet();
      const body = {
        values: [[new Date().toISOString(), "event", Math.floor(Math.random()*100)]],
      };
      const res = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(SHEET_NAME)}!A:C:append?valueInputOption=USER_ENTERED`,
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify(body),
        }
      );
      const data = await res.json();
      alert("Row appended!");
    }

    document.getElementById("btnSignIn").addEventListener("click", signIn);
    document.getElementById("btnRead").addEventListener("click", readSheet);
    document.getElementById("btnAppend").addEventListener("click", appendRow);
    document.getElementById("btnNewSession").addEventListener("click", startSession);
    document.getElementById("btnSuccess").addEventListener("click", () => recordResult(1));
    document.getElementById("btnFail").addEventListener("click", () => recordResult(0));

    async function handleCreateSheet() {
      try {
        setMsg("Creating spreadsheet…");
        await ensureSignedIn();
        const created = await createSpreadsheet();
        spreadsheetId = created.spreadsheetId;
        localStorage.setItem(STORAGE_KEY, spreadsheetId);
        setMsg(`Created: https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`);
        updateUI();
      } catch (e) {
        setMsg(String(e));
      }
    }

    async function handleUseSheetId() {
      try {
        const val = document.getElementById("inputSheetId").value.trim();
        if (!val) { setMsg("Please paste a Spreadsheet ID."); return; }
        setMsg("Validating spreadsheet…");
        await ensureSignedIn();
        const meta = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${val}?fields=spreadsheetId,sheets.properties.title`,
          { headers: { Authorization: `Bearer ${accessToken}` } }
        );
        if (!meta.ok) { setMsg("Cannot access that spreadsheet. Check ID and sharing."); return; }
        const metaJson = await meta.json();
        spreadsheetId = metaJson.spreadsheetId;
        // Ensure tab exists
        const titles = (metaJson.sheets || []).map(s => s.properties && s.properties.title);
        if (!titles.includes(SHEET_NAME)) {
          await addSheet(spreadsheetId, SHEET_NAME);
        }
        localStorage.setItem(STORAGE_KEY, spreadsheetId);
        setMsg(`Configured: https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`);
        updateUI();
      } catch (e) {
        setMsg(String(e));
      }
    }

    document.getElementById("btnCreateSheet").addEventListener("click", handleCreateSheet);
    document.getElementById("btnUseSheetId").addEventListener("click", handleUseSheetId);

    // Initialize UI state from storage/constant
    spreadsheetId = SPREADSHEET_ID || localStorage.getItem(STORAGE_KEY) || null;
    updateUI();
  </script>
</body>
</html>
