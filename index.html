<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Putting Stats</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; margin: 24px; }
    .row { margin-top: 8px; }
    input, button { font-size: 16px; padding: 8px; }
    pre { background: #f6f6f6; padding: 12px; border-radius: 8px; overflow: auto; }
    .muted { color: #666; }
    /* Putt emphasis + LR colors */
    #currentPutt { font-size: 1.25em; font-weight: 700; }
    #nextPutts { font-size: 1.12em; font-weight: 600; }
    .lr-left { color: #1f6feb; }
    .lr-right { color: #d1242f; }
    /* Toasts */
    #toasts { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px; align-items: center; pointer-events: none; }
    .toast { min-width: 200px; max-width: 80vw; color: white; padding: 10px 14px; border-radius: 8px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); opacity: 0; transform: translateY(10px); transition: opacity 180ms ease, transform 180ms ease; pointer-events: auto; font-weight: 600; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast-success { background: #1a7f37; }
    .toast-fail { background: #b3261e; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h1>Disc Golf Putting Stats</h1>

  <div id="setup">
    <div class="row"><strong>First-time setup</strong></div>
    <div class="row">
      <button id="btnCreateSheet">Create New Spreadsheet</button>
      <span class="muted">Creates a sheet with tab <code>putting-stats</code>.</span>
    </div>
    <div class="row">
      <input id="inputSheetId" placeholder="Paste existing Spreadsheet ID" size="40" />
      <button id="btnUseSheetId">Use ID</button>
    </div>
    <div id="msg" class="row muted"></div>
  </div>

  

  <div id="controls" class="row" style="display:none">
    <button id="btnCountRows">Count rows</button>
    <span id="rowsLabel" class="muted" style="margin-left:8px"></span>
  </div>

  <pre id="out"></pre>
  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <div id="sessionUI" style="display:none">
    <div class="row">
      <button id="btnNewSession">New Session</button>
      <button id="btnAbort" style="margin-left:8px">Abort Session</button>
      <span id="sessInfo" class="muted" style="margin-left:8px"></span>
    </div>
    <div class="row"><strong>Current:</strong> <span id="currentPutt"></span></div>
    <div class="row"><span class="muted">Next: <span id="nextPutts"></span></span> • <span id="progress">0/8</span></div>
    <div class="row">
      <button id="btnSuccess">Success</button>
      <button id="btnFail">Fail</button>
    </div>
  </div>

  <script>
    let tokenClient, accessToken, scopes = "https://www.googleapis.com/auth/spreadsheets";
    const CLIENT_ID = "775302818197-p5jn3hq79uv93b66n5109b264sdgdctc.apps.googleusercontent.com"; // provided by user
    const SHEET_NAME = "putting-stats"; // hardcoded sheet/tab name
    const SPREADSHEET_ID = ""; // optional: hardcode an existing spreadsheetId to skip setup
    const STORAGE_KEY = "putting_stats_spreadsheet_id";
    let spreadsheetId = null;
    const PUTTS = [
      "L 6m","L 8m","L 10m","L step",
      "R 6m","R 8m","R 10m","R step"
    ];
    const HEADERS = ["date","time", ...PUTTS];

    // Session state
    let session = null; // { number, date, time, order[], index, results: Map name->0/1 }

    function setMsg(text) {
      const el = document.getElementById("msg");
      if (el) el.textContent = text || "";
    }

    function updateUI() {
      const hasId = !!spreadsheetId;
      document.getElementById("setup").style.display = hasId ? "none" : "block";
      document.getElementById("controls").style.display = hasId ? "block" : "none";
      document.getElementById("sessionUI").style.display = hasId ? "block" : "none";
    }

    function showToast(message, kind) {
      const cont = document.getElementById("toasts");
      const el = document.createElement("div");
      el.className = `toast ${kind === "fail" ? "toast-fail" : "toast-success"}`;
      el.textContent = message;
      cont.appendChild(el);
      // Allow transition to apply
      requestAnimationFrame(() => { el.classList.add("show"); });
      setTimeout(() => {
        el.classList.remove("show");
        setTimeout(() => { el.remove(); }, 220);
      }, 3000);
    }

    async function ensureHeader(id) {
      // Check first row; if missing or different, write headers
      const range = `${SHEET_NAME}!A1:J1`;
      const res = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(range)}`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      if (!res.ok) throw new Error(`Failed to read headers: ${await res.text()}`);
      const data = await res.json();
      const row = (data.values && data.values[0]) || [];
      const equal = row.length === HEADERS.length && row.every((v,i)=>String(v)===String(HEADERS[i]));
      if (!equal) {
        // Clear previous header row width (A1:K1) to avoid leftover cells after schema change
        await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(`${SHEET_NAME}!A1:K1`)}:clear`,
          {
            method: "POST",
            headers: { Authorization: `Bearer ${accessToken}` },
          }
        );
        const put = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(range)}?valueInputOption=RAW`,
          {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${accessToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ values: [HEADERS] }),
          }
        );
        if (!put.ok) throw new Error(`Failed to set headers: ${await put.text()}`);
      }
    }

    // removed: getNextSessionNumber — we no longer maintain a manual counter

    function shuffle(arr) {
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--) {
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function nowParts() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return { date: `${yyyy}-${mm}-${dd}`, time: `${hh}:${mi}` };
    }

    async function startSession() {
      try {
        setMsg("");
        await ensureSignedIn();
        const id = await ensureSpreadsheet();
        await ensureHeader(id);
        const { date, time } = nowParts();
        session = {
          date,
          time,
          order: shuffle(PUTTS),
          index: 0,
          results: {}
        };
        updateSessionUI();
        document.getElementById("sessionUI").style.display = "block";
      } catch (e) {
        setMsg(String(e));
      }
    }

    function updateSessionUI() {
      const sessInfo = document.getElementById("sessInfo");
      const btnSuccess = document.getElementById("btnSuccess");
      const btnFail = document.getElementById("btnFail");
      if (!session) {
        if (sessInfo) sessInfo.textContent = "No active session";
        document.getElementById("currentPutt").textContent = "";
        document.getElementById("nextPutts").textContent = "";
        document.getElementById("progress").textContent = `0/${PUTTS.length}`;
        btnSuccess.disabled = true;
        btnFail.disabled = true;
        return;
      }
      if (sessInfo) sessInfo.textContent = `Session — ${session.date} ${session.time}`;
      const curr = session.order[session.index];
      document.getElementById("currentPutt").innerHTML = curr ? formatPuttLabel(curr) : "Done";
      const next1 = session.order[session.index+1] || "";
      document.getElementById("nextPutts").innerHTML = next1 ? formatPuttLabel(next1) : "";
      document.getElementById("progress").textContent = `${Math.min(session.index, PUTTS.length)}/${PUTTS.length}`;
      const enable = session.index < PUTTS.length;
      btnSuccess.disabled = !enable;
      btnFail.disabled = !enable;
    }

    function abortSession() {
      if (!session) {
        showToast("No active session", "fail");
        return;
      }
      session = null;
      updateSessionUI();
      showToast("Session aborted", "fail");
    }

    function formatPuttLabel(name) {
      if (!name) return "";
      const isLeft = name.startsWith("L ");
      const cls = isLeft ? "lr-left" : "lr-right";
      return `<span class="${cls}">${name}</span>`;
    }

    async function recordResult(val) {
      if (!session) return;
      const curr = session.order[session.index];
      if (curr) session.results[curr] = val;
      showToast(val ? "Success" : "Fail", val ? "success" : "fail");
      session.index++;
      if (session.index >= PUTTS.length) {
        await finalizeSession();
      }
      updateSessionUI();
    }

    async function finalizeSession() {
      try {
        const row = [session.date, session.time, ...PUTTS.map(p => session.results[p] ? 1 : 0)];
        const id = spreadsheetId;
        const res = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(SHEET_NAME)}!A:J:append?valueInputOption=USER_ENTERED`,
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${accessToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ values: [row] }),
          }
        );
        if (!res.ok) throw new Error(`Failed to append session: ${await res.text()}`);
        setMsg("Session saved.");
        showToast("Session saved", "success");
      } catch (e) {
        setMsg(String(e));
        showToast("Save failed", "fail");
      }
    }

    function initAuth() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: scopes,
        callback: (resp) => {
          accessToken = resp.access_token;
          const st = document.getElementById("status");
          if (st) st.textContent = "Signed in";
        },
      });
    }

    function signIn() {
      if (!tokenClient) initAuth();
      tokenClient.clientId = CLIENT_ID;
      tokenClient.requestAccessToken();
    }

    // Ensure we have an access token; if not, trigger sign-in popup from this user gesture
    function ensureSignedIn() {
      return new Promise((resolve) => {
        if (accessToken) return resolve();
        if (!tokenClient) initAuth();
        tokenClient.clientId = CLIENT_ID;
        const prevCb = tokenClient.callback;
        tokenClient.callback = (resp) => {
          accessToken = resp.access_token;
          const st = document.getElementById("status");
          if (st) st.textContent = "Signed in";
          tokenClient.callback = prevCb; // restore
          resolve();
        };
        tokenClient.requestAccessToken();
      });
    }

    async function ensureSpreadsheet() {
      if (!spreadsheetId) {
        spreadsheetId = SPREADSHEET_ID || localStorage.getItem(STORAGE_KEY) || null;
      }
      if (!spreadsheetId) throw new Error("Spreadsheet not configured. Create one or paste an ID.");
      const meta = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=sheets.properties.title`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      if (!meta.ok) {
        const err = await meta.text();
        throw new Error(`Failed to fetch spreadsheet metadata: ${err}`);
      }
      const metaJson = await meta.json();
      const titles = (metaJson.sheets || []).map(s => s.properties && s.properties.title);
      if (!titles.includes(SHEET_NAME)) {
        await addSheet(spreadsheetId, SHEET_NAME);
      }
      return spreadsheetId;
    }

    async function createSpreadsheet() {
      const body = {
        properties: { title: "Disc Golf Putting Stats" },
        sheets: [{ properties: { title: SHEET_NAME } }],
      };
      const res = await fetch("https://sheets.googleapis.com/v4/spreadsheets", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(body),
      });
      if (!res.ok) {
        const err = await res.text();
        throw new Error(`Failed to create spreadsheet: ${err}`);
      }
      return await res.json();
    }

    async function addSheet(spreadsheetId, title) {
      const body = {
        requests: [ { addSheet: { properties: { title } } } ]
      };
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(body),
      });
      if (!res.ok) {
        const err = await res.text();
        throw new Error(`Failed to add sheet: ${err}`);
      }
      return await res.json();
    }

    async function readSheet() {
      if (!accessToken) await ensureSignedIn();
      const id = await ensureSpreadsheet();
      const range = `${SHEET_NAME}!A1:C10`;
      const res = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(range)}?majorDimension=ROWS`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      const data = await res.json();
      document.getElementById("out").textContent = JSON.stringify(data.values || [], null, 2);
    }

    async function appendRow() {
      if (!accessToken) await ensureSignedIn();
      const id = await ensureSpreadsheet();
      const body = {
        values: [[new Date().toISOString(), "event", Math.floor(Math.random()*100)]],
      };
      const res = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(SHEET_NAME)}!A:C:append?valueInputOption=USER_ENTERED`,
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify(body),
        }
      );
      const data = await res.json();
      alert("Row appended!");
    }

    async function countRows() {
      try {
        await ensureSignedIn();
        const id = await ensureSpreadsheet();
        const range = `${SHEET_NAME}!A:A`;
        const res = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${encodeURIComponent(range)}?majorDimension=ROWS`,
          { headers: { Authorization: `Bearer ${accessToken}` } }
        );
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        const rows = (data.values || []).length;
        const lbl = document.getElementById("rowsLabel");
        if (lbl) lbl.textContent = `Rows: ${rows}`;
      } catch (e) {
        const lbl = document.getElementById("rowsLabel");
        if (lbl) lbl.textContent = `Count failed`;
      }
    }

    document.getElementById("btnCountRows").addEventListener("click", countRows);
    document.getElementById("btnNewSession").addEventListener("click", startSession);
    document.getElementById("btnAbort").addEventListener("click", abortSession);
    document.getElementById("btnSuccess").addEventListener("click", () => recordResult(1));
    document.getElementById("btnFail").addEventListener("click", () => recordResult(0));

    async function handleCreateSheet() {
      try {
        setMsg("Creating spreadsheet…");
        await ensureSignedIn();
        const created = await createSpreadsheet();
        spreadsheetId = created.spreadsheetId;
        localStorage.setItem(STORAGE_KEY, spreadsheetId);
        setMsg(`Created: https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`);
        updateUI();
      } catch (e) {
        setMsg(String(e));
      }
    }

    async function handleUseSheetId() {
      try {
        const val = document.getElementById("inputSheetId").value.trim();
        if (!val) { setMsg("Please paste a Spreadsheet ID."); return; }
        setMsg("Validating spreadsheet…");
        await ensureSignedIn();
        const meta = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${val}?fields=spreadsheetId,sheets.properties.title`,
          { headers: { Authorization: `Bearer ${accessToken}` } }
        );
        if (!meta.ok) { setMsg("Cannot access that spreadsheet. Check ID and sharing."); return; }
        const metaJson = await meta.json();
        spreadsheetId = metaJson.spreadsheetId;
        // Ensure tab exists
        const titles = (metaJson.sheets || []).map(s => s.properties && s.properties.title);
        if (!titles.includes(SHEET_NAME)) {
          await addSheet(spreadsheetId, SHEET_NAME);
        }
        localStorage.setItem(STORAGE_KEY, spreadsheetId);
        setMsg(`Configured: https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`);
        updateUI();
      } catch (e) {
        setMsg(String(e));
      }
    }

    document.getElementById("btnCreateSheet").addEventListener("click", handleCreateSheet);
    document.getElementById("btnUseSheetId").addEventListener("click", handleUseSheetId);

    // Initialize UI state from storage/constant
    spreadsheetId = SPREADSHEET_ID || localStorage.getItem(STORAGE_KEY) || null;
    updateUI();
  </script>
</body>
</html>
